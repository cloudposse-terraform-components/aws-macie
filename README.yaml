name: "aws-macie"
# Canonical GitHub repo
github_repo: "cloudposse-terraform-components/aws-macie"
# Short description of this project
description: |-
  This component is responsible for configuring Macie within an AWS Organization.

  Amazon Macie is a data security service that discovers sensitive data by using machine learning and pattern matching,
  provides visibility into data security risks, and enables automated protection against those risks.

  To help you manage the security posture of your organization's Amazon Simple Storage Service (Amazon S3) data estate,
  Macie provides you with an inventory of your S3 buckets, and automatically evaluates and monitors the buckets for
  security and access control. If Macie detects a potential issue with the security or privacy of your data, such as a
  bucket that becomes publicly accessible, Macie generates a finding for you to review and remediate as necessary.

  Macie also automates discovery and reporting of sensitive data to provide you with a better understanding of the data
  that your organization stores in Amazon S3. To detect sensitive data, you can use built-in criteria and techniques that
  Macie provides, custom criteria that you define, or a combination of the two. If Macie detects sensitive data in an S3
  object, Macie generates a finding to notify you of the sensitive data that Macie found.

  In addition to findings, Macie provides statistics and other data that offer insight into the security posture of your
  Amazon S3 data, and where sensitive data might reside in your data estate. The statistics and data can guide your
  decisions to perform deeper investigations of specific S3 buckets and objects. You can review and analyze findings,
  statistics, and other data by using the Amazon Macie console or the Amazon Macie API. You can also leverage Macie
  integration with Amazon EventBridge and AWS Security Hub to monitor, process, and remediate findings by using other
  services, applications, and systems.
usage: |-
  **Stack Level**: Regional

  ## Deployment Overview

  This component uses the **delegated administrator** deployment model, which requires a **3-step deployment process**.
  The component must be deployed multiple times with different variables to configure the AWS Organization.

  Macie follows the same deployment pattern as GuardDuty and Security Hub.

  In the examples below, we assume that the AWS Organization Management account is `root` and the AWS Organization
  Delegated Administrator account is `security`, both in the `core` tenant.

  ### Architecture

  ```
  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                         AWS Organization                                     │
  │                                                                              │
  │  ┌────────────────────────────────────────────────────────────────────────┐ │
  │  │  Organization Management Account (root)                                │ │
  │  │  STEP 2: Delegate Macie administration to security account             │ │
  │  │  - Creates: aws_macie2_organization_admin_account                      │ │
  │  │  - Requires: SuperAdmin permissions (privileged: true)                 │ │
  │  └────────────────────────────────────────────────────────────────────────┘ │
  │                              │                                              │
  │                              ▼ Delegation                                   │
  │  ┌────────────────────────────────────────────────────────────────────────┐ │
  │  │  Delegated Administrator Account (security)                            │ │
  │  │  STEP 1 (FIRST): Create Macie account (admin_delegated: false)         │ │
  │  │  - Creates: aws_macie2_account                                         │ │
  │  │                                                                        │ │
  │  │  STEP 3 (LAST): Configure org settings (admin_delegated: true)         │ │
  │  │  - Creates: awsutils_macie2_organization_settings                      │ │
  │  │  - Enables member accounts, configures finding publishing              │ │
  │  └────────────────────────────────────────────────────────────────────────┘ │
  │                              ▲                                              │
  │                              │ Findings                                     │
  │  ┌────────────────────────────────────────────────────────────────────────┐ │
  │  │  Member Accounts (all other accounts)                                  │ │
  │  │  - Automatically enabled by delegated administrator                    │ │
  │  │  - S3 buckets automatically inventoried and monitored                  │ │
  │  │  - Findings sent to security account                                   │ │
  │  └────────────────────────────────────────────────────────────────────────┘ │
  └─────────────────────────────────────────────────────────────────────────────┘
  ```

  ### Deployment Steps Summary

  | Step | Account | Variable | Resources Created |
  |------|---------|----------|-------------------|
  | 1 | Security | `admin_delegated: false` | `aws_macie2_account` |
  | 2 | Root | `privileged: true` | `aws_macie2_organization_admin_account` |
  | 3 | Security | `admin_delegated: true` | `awsutils_macie2_organization_settings` |

  ### Step 1: Deploy to Delegated Administrator Account (FIRST)

  First, the component is deployed to the
  [Delegated Administrator](https://docs.aws.amazon.com/macie/latest/user/accounts-mgmt-ao-integrate.html) account to
  create the Macie account. This **must be done before** the root account delegates administration.

  ```yaml
  # core-ue1-security
  components:
    terraform:
      macie/delegated-administrator:
        metadata:
          component: macie
        vars:
          enabled: true
          delegated_administrator_account_name: core-security
          environment: ue1
          region: us-east-1
          # Not yet delegated - creates Macie account only
          admin_delegated: false
  ```

  ```bash
  atmos terraform apply macie/delegated-administrator -s core-ue1-security
  ```

  ### Step 2: Deploy to Organization Management (root) Account

  Next, the component is deployed to the AWS Organization Management account to delegate Macie administration
  to the security account.

  Note that you need `SuperAdmin` permissions as we are deploying to the AWS Organization Management account. Since we are
  using the `SuperAdmin` user, it will already have access to the state bucket, so we set the `role_arn` of the backend
  config to null and set `var.privileged` to `true`.

  ```yaml
  # core-ue1-root
  components:
    terraform:
      macie/root:
        metadata:
          component: macie
        backend:
          s3:
            role_arn: null
        vars:
          enabled: true
          delegated_administrator_account_name: core-security
          environment: ue1
          region: us-east-1
          privileged: true
  ```

  ```bash
  atmos terraform apply macie/root -s core-ue1-root
  ```

  ### Step 3: Deploy Organization Settings in Delegated Administrator Account (LAST)

  Finally, the component is deployed to the Delegated Administrator Account again to create the organization-wide
  configuration. Set `var.admin_delegated` to `true` to indicate that the delegation has been completed.

  ```yaml
  # core-ue1-security
  components:
    terraform:
      macie/org-settings:
        metadata:
          component: macie
        vars:
          enabled: true
          delegated_administrator_account_name: core-security
          environment: ue1
          region: us-east-1
          admin_delegated: true
  ```

  ```bash
  atmos terraform apply macie/org-settings -s core-ue1-security
  ```

  ### Multi-Region Deployment

  Macie is a **regional service**. Deploy to each region where you have S3 buckets to monitor:

  ```bash
  # Deploy to us-east-1 (all 3 steps)
  atmos terraform apply macie/delegated-administrator -s core-ue1-security
  atmos terraform apply macie/root -s core-ue1-root
  atmos terraform apply macie/org-settings -s core-ue1-security

  # Deploy to us-west-2 (all 3 steps)
  atmos terraform apply macie/delegated-administrator -s core-uw2-security
  atmos terraform apply macie/root -s core-uw2-root
  atmos terraform apply macie/org-settings -s core-uw2-security
  ```

  ## Key Features

  - **Sensitive Data Discovery**: Automatically discovers PII, financial data, credentials, and other sensitive
    information in S3 using machine learning and pattern matching
  - **S3 Bucket Inventory**: Provides comprehensive inventory of S3 buckets with security and access control evaluation
  - **Policy Findings**: Detects security issues like publicly accessible buckets, disabled encryption, external sharing
  - **Sensitive Data Findings**: Reports discovered sensitive data including location and data type
  - **Security Hub Integration**: Findings published to AWS Security Hub for centralized security management
  - **EventBridge Integration**: Findings published to EventBridge for automated remediation workflows
  - **Multi-account Coverage**: Monitors S3 data across all accounts in the AWS Organization

  ## Finding Publishing Frequency

  The `finding_publishing_frequency` variable controls how often Macie publishes findings to Security Hub and EventBridge:

  | Value | Description |
  |-------|-------------|
  | `FIFTEEN_MINUTES` | Publish every 15 minutes (default, recommended) |
  | `ONE_HOUR` | Publish every hour |
  | `SIX_HOURS` | Publish every 6 hours |

  ## Prerequisites

  Before deploying this component:

  1. **AWS Organizations** must be configured with the `macie.amazonaws.com` service access principal enabled
  2. **account-map** component must be deployed to identify security and root accounts
  3. **Security Hub** (recommended) should be deployed to receive findings

  <!-- prettier-ignore-start -->
  <!-- prettier-ignore-end -->
references:
  - name: "AWS Macie Documentation"
    description: "Official AWS Macie service documentation"
    url: "https://docs.aws.amazon.com/macie/"
  - name: "AWS Macie User Guide"
    description: "Comprehensive guide for setting up and using Macie"
    url: "https://docs.aws.amazon.com/macie/latest/user/what-is-macie.html"
  - name: "Setting Up Macie"
    description: "Getting started with AWS Macie"
    url: "https://docs.aws.amazon.com/macie/latest/user/getting-started.html"
  - name: "Macie Discovery Jobs"
    description: "Creating sensitive data discovery jobs"
    url: "https://docs.aws.amazon.com/macie/latest/user/discovery-jobs.html"
  - name: "Macie Findings"
    description: "Understanding Macie findings types and formats"
    url: "https://docs.aws.amazon.com/macie/latest/user/findings.html"
  - name: "Custom Data Identifiers"
    description: "Creating custom patterns for sensitive data detection"
    url: "https://docs.aws.amazon.com/macie/latest/user/custom-data-identifiers.html"
  - name: "Macie Pricing"
    description: "AWS Macie pricing information"
    url: "https://aws.amazon.com/macie/pricing/"
  - name: "Terraform aws_macie2_account"
    description: "Terraform resource documentation for Macie account"
    url: "https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/macie2_account"
  - name: "Terraform aws_macie2_organization_admin_account"
    description: "Terraform resource documentation for Macie organization admin"
    url: "https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/macie2_organization_admin_account"
tags:
  - component/macie
  - layer/security-and-compliance
  - provider/aws
# Categories of this project
categories:
  - component/macie
  - layer/security-and-compliance
  - provider/aws
# License of this project
license: "APACHE2"
# Badges to display
badges:
  - name: Latest Release
    image: https://img.shields.io/github/release/cloudposse-terraform-components/aws-macie.svg?style=for-the-badge
    url: https://github.com/cloudposse-terraform-components/aws-macie/releases/latest
  - name: Slack Community
    image: https://slack.cloudposse.com/for-the-badge.svg
    url: https://slack.cloudposse.com
related:
  - name: "Cloud Posse Terraform Modules"
    description: Our collection of reusable Terraform modules used by our reference architectures.
    url: "https://docs.cloudposse.com/modules/"
  - name: "Atmos"
    description: "Atmos is like docker-compose but for your infrastructure"
    url: "https://atmos.tools"
  - name: "aws-guardduty Component"
    description: "Related component for AWS GuardDuty threat detection"
    url: "https://github.com/cloudposse-terraform-components/aws-guardduty"
  - name: "aws-securityhub Component"
    description: "Related component for AWS Security Hub"
    url: "https://github.com/cloudposse-terraform-components/aws-securityhub"
contributors: [] # If included generates contribs
